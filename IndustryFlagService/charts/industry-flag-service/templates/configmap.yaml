#################################################################################
# Tractus-X - Industry Flag Service
#
# Copyright (c) 2025 CGI Deutschland B.V. & Co. KG
# Copyright (c) 2025 Contributors to the Eclipse Foundation
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License, Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
# either express or implied. See the
# License for the specific language govern in permissions and limitations
# under the License.
#
# SPDX-License-Identifier: Apache-2.0
#################################################################################

{{- if .Values.backend.enabled }}

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-ifs-backend-config
data:
  logging.yml: |-
    version: 1
    disable_existing_loggers: False

    formatters:
      default:
        format: '%(asctime)s [%(levelname)-8s] [%(name)-15s] %(message)s'
        datefmt: '%Y-%m-%d %H:%M:%S'

    handlers:
      console:
        class : logging.StreamHandler
        formatter: default
        level   : DEBUG
        stream  : ext://sys.stdout
      file:
        class : logging.handlers.RotatingFileHandler
        formatter: default
        mode: a

    loggers:
        development:
            level: DEBUG
            handlers: [console, file]
            propagate: no

        staging:
            level: INFO
            handlers: [console, file]
            propagate: no

        production:
            level: WARNING
            handlers: [file]
            propagate: no

    root:
        level: INFO
        handlers: [console, file]
        
  configuration.yml: |-
    authorization:
      enabled: {{ .Values.backend.authorization.enabled }}
      apiKey: 
        key: {{ .Values.backend.authorization.apiKey.key }}
        value: {{ .Values.backend.authorization.apiKey.value }}

    flags:
      {{- toYaml .Values.backend.flags | nindent 12 }}

    startup:
      checks: {{ .Values.backend.startup.checks }}
      refresh_interval: {{ .Values.backend.startup.refresh_interval }}

    ifs:
      ## Refresh interval for the cache of applications
      refresh_interval: {{ .Values.backend.ifs.refresh_interval }}
      ## DCT Type used to find the applications in the cache
      dct_type: {{ .Values.backend.ifs.dct_type }}
      ## JSON array of policies that are allowed to be used
      policies: 
        {{- toYaml .Values.backend.ifs.policies | nindent 12 }}
      

    edc:
      url: {{ .Values.backend.edc.url }}
      apis:
        readiness: {{ .Values.backend.edc.apis.readiness }}
        catalog: {{ .Values.backend.edc.apis.catalog }}
        edr_prefix: {{ .Values.backend.edc.apis.edr_prefix }}
        view_edr: {{ .Values.backend.edc.apis.view_edr }}
        transfer_edr: {{ .Values.backend.edc.apis.transfer_edr }}
        dsp: {{ .Values.backend.edc.apis.dsp }}

      oauth:
        token_url: "{{ .Values.backend.edc.oauth.token_url }}"
        client_id: "{{ .Values.backend.edc.oauth.client_id }}"
        client_secret: "{{ .Values.backend.edc.oauth.client_secret }}"

      participantId: {{ .Values.backend.edc.participantId }}
      
      dct_type_key: {{ .Values.backend.edc.dct_type_key | quote }}

      cache:
        expiration_time: {{ .Values.backend.edc.cache.expiration_time }}

    discovery:
      url: {{ .Values.backend.discovery.url }}
      keys:
        edc_discovery: {{ .Values.backend.discovery.keys.edc_discovery }}

    catenax:
      centralidp:
        url: {{ .Values.backend.catenax.centralidp.url }}
        realm: {{ .Values.backend.catenax.centralidp.realm }}
        clientid: {{ .Values.backend.catenax.centralidp.clientid }}
        clientsecret: {{ .Values.backend.catenax.centralidp.clientsecret }}
{{- end }}